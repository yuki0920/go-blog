# Goのメモ

## 開発環境構築準備

### VS Code用ツール群インストール

1.  `command + shift + P` でコマンドパレットを表示
2. コマンドパレットに go tool と入力して `Go: Install/Update Tools` を選択し、インストール

### 関数の定義ジャンプ

- アプリケーションのソースコードだけでなく標準ライブラリも定義ジャンプできる

### Repl

```sh
git clone https://github.com/x-motemen/gore.git
cd gore
docker build -t gore .
docker run -it --rm gore --autoimport
```

## パッケージ管理

### 初期化

```sh
$  go mod init $(git config user.name)/$(basename `pwd`)
```

### 依存管理


参照しているパケージを整理する

```sh
$  go mod tidy
```

- ソースコードを検査して、どのような外部パッケージを利用しているかを判定する
- ソースコード内で利用されている外部パッケージは go.mod と go.sum というファイルに書き出される
- 直接的に利用しているパッケージは go.mod に、間接的に利用しているパッケージは go.sum に記載される
- indirect というコメントは、直接依存しているモジュールではないことを表現している

### ダウンロード

```sh
$ go mod download
```

- ダウンロードされた外部パッケージのソースコードは `$HOME/go/pkg/mod/` に配置される

## 文法

### 基本
- 構造体(struct):
  - 複数の任意の型の値を1つにまとめたもの。typeと組み合わせて新しい型を定義することが多い
  - 値型のため、関数の引数に渡すとコピーが生成され元の構造体に影響を与えない。参照渡しにするためには、構造体へのポインタを渡す
- メソッド:
  - 構造体と手続きを結びつけるためのもの。任意の型に特化した関数を定義する
  - オブジェクト指向においてクラスやインスタンスの手続きとしてのメソッドとは異なる
- 型(type):
  - すでに定義されている型をもとに、新しい型を定義するための機能
- インターフェース:
  - 任意の型がどのようなメソッドを実装するべきかを規定するための枠組み
  - インターフェースに定義するメソッドは外部から参照されることが多い。そのため、大文字始まりのメソッド名となる
  - `interface{}`型は実装すべきメソッドが1つも定義されていないインターフェースのこと。TypeScript的には`any`型
  - 型アサーション: `interface{}`型によって隠蔽されたもとの型を復元する仕組み

```go
// Go組み込みのerror型インターフェフェース(予約後)
type error interface {
  Error() string
}
```

```go
// 構造体
type MyError struct {
  Message string
  ErrCode int
}
// メソッド
func (e * MyError) Error() string {
  return e.Message
}
// インスタンスをstructを返す関数
func RaiseError() error {
  // &でMyErrorのstructのポインタを表す
  return &MyError{Message: "エラーがー発生しました", ErrCode: 500}
}

err := RaiseError()
// 返り値はerror型
err.Error // == "エラーが発生しました"

// 型アサーションによって本来の方を取り出す
e, ok := err.(*MyError)
if ok {
  e.ErrCode // 500
}
```

### io.Writer/io.Reader

- ともにインターフェースであり、入出力に共通する仕様を満たすメソッドを持つ型
- io.Writer: Witeメソッドは、バイト列bを書き込み、書き込んだバイト数nとエラーerrを返す
- io.Reader: Readメソッドは、バッファpを受け取り、読み込んだバイト数nとエラーerrを返す

## リクエストからレスポンスの流れ

### 用語
- マルチプレクサ: `Echo` のインスタンスで、ミドルウェアを設定したりリクエストをハンドラに振り分ける
- ハンドラ: リクエストに対する具体的な処理をする

### 流れ

- サーバーがリクエストを受け取ったら、マルチプレクサがリクエストのURLに応じたハンドラに処理を振り分ける
- ハンドラは引数(`echo.Context`の型を持つ)からリクエストのパラメータやフォームの値をから読み取り、必要に応じてDBアクセスを伴いリソースの作成、更新、削除、返却を担う
  - リソース作成の場合は、
    - リクエストを構造体にバインドする
    - バリデーションを実行する
    - バインドした構造体をリポジトリに渡しDBを更新する
    - レスポンスを返す

### メモリ管理

変数をスタック(順番に取り出すため高速)に配置するかヒープ(動的に取り出すため低速)に配置するかはコンパイラが自動的に判断する。
デフォルトでは、スタックを選択する

- スタック: 関数内でしか利用されない場合
- ヒープ: ポインタを他の関数に渡したり、関数の返り値として返すような場合は
